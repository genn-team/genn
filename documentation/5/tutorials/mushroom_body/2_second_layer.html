<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Adding Kenyon Cells &mdash; PyGeNN  documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=19f00094" />
      <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery.css?v=d2d258e8" />
      <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery-binder.css?v=f4aeca0c" />
      <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery-dataframe.css?v=2082cf3c" />
      <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery-rendered-html.css?v=1277b6f3" />
      <link rel="stylesheet" type="text/css" href="../../_static/nbsphinx-code-cells.css?v=2aa19091" />

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../../_static/documentation_options.js?v=5929fcd5"></script>
        <script src="../../_static/doctools.js?v=9a2dae69"></script>
        <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
        <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Feedback-inhibition based gain control" href="3_second_layer_gain_control.html" />
    <link rel="prev" title="Presenting latency-coded inputs" href="1_first_layer.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            PyGeNN
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../upgrading.html">Upgrading from GeNN 4</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../building_networks.html">Building networks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../simulating_networks.html">Simulating networks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../custom_models.html">Custom models</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../bibliography.html">Bibliography</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">Tutorials</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../comp_neuro_101/1_neurons.html">Defining populations of neurons</a></li>
<li class="toctree-l2"><a class="reference internal" href="../comp_neuro_101/2_synapses.html">Adding synapses</a></li>
<li class="toctree-l2"><a class="reference internal" href="../mnist_inference/tutorial_1.html">Classification of a single digit</a></li>
<li class="toctree-l2"><a class="reference internal" href="../mnist_inference/tutorial_2.html">Classification of the entire test set</a></li>
<li class="toctree-l2"><a class="reference internal" href="../mnist_inference/tutorial_3.html">Faster classification of the whole test set</a></li>
<li class="toctree-l2"><a class="reference internal" href="1_first_layer.html">Presenting latency-coded inputs</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Adding Kenyon Cells</a></li>
<li class="toctree-l2"><a class="reference internal" href="3_second_layer_gain_control.html">Feedback-inhibition based gain control</a></li>
<li class="toctree-l2"><a class="reference internal" href="4_third_layer.html">Output neurons and learning</a></li>
<li class="toctree-l2"><a class="reference internal" href="5_testing.html">Testing</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../userproject/index.html">User projects</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../source/pygenn.html">Reference documentation</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">PyGeNN</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Tutorials</a></li>
      <li class="breadcrumb-item active">Adding Kenyon Cells</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../_sources/tutorials/mushroom_body/2_second_layer.ipynb.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="Adding-Kenyon-Cells">
<h1>Adding Kenyon Cells<a class="headerlink" href="#Adding-Kenyon-Cells" title="Link to this heading"></a></h1>
<p>In this second tutorial we add a large population of Kenyon Cells to the mushroom body and visualize their spiking activity in response to latency coded MNIST digits.</p>
<section id="Install-PyGeNN-wheel-from-Google-Drive">
<h2>Install PyGeNN wheel from Google Drive<a class="headerlink" href="#Install-PyGeNN-wheel-from-Google-Drive" title="Link to this heading"></a></h2>
<p>Download wheel file</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="s2">&quot;google.colab&quot;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">get_ipython</span><span class="p">()):</span>
    <span class="o">!</span>gdown<span class="w"> </span>1qlNCa_WT7sOmifYjPgGyggqUGsPiHn5y
    <span class="o">!</span>pip<span class="w"> </span>install<span class="w"> </span>pygenn-5.3.0-cp312-cp312-linux_x86_64.whl
    <span class="o">%</span><span class="k">env</span> CUDA_PATH=/usr/local/cuda
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Downloading...
From: https://drive.google.com/uc?id=1wUeynMCgEOl2oK2LAd4E0s0iT_OiNOfl
To: /content/pygenn-5.1.0-cp311-cp311-linux_x86_64.whl
100% 8.49M/8.49M [00:00&lt;00:00, 52.1MB/s]
Processing ./pygenn-5.1.0-cp311-cp311-linux_x86_64.whl
Requirement already satisfied: numpy&gt;=1.17 in /usr/local/lib/python3.11/dist-packages (from pygenn==5.1.0) (1.26.4)
Requirement already satisfied: psutil in /usr/local/lib/python3.11/dist-packages (from pygenn==5.1.0) (5.9.5)
Requirement already satisfied: setuptools in /usr/local/lib/python3.11/dist-packages (from pygenn==5.1.0) (75.1.0)
pygenn is already installed with the same version as the provided wheel. Use --force-reinstall to force an installation of the wheel.
env: CUDA_PATH=/usr/local/cuda
</pre></div></div>
</div>
</section>
<section id="Install-MNIST-package">
<h2>Install MNIST package<a class="headerlink" href="#Install-MNIST-package" title="Link to this heading"></a></h2>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>pip<span class="w"> </span>install<span class="w"> </span>mnist
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Collecting mnist
  Using cached mnist-0.2.2-py2.py3-none-any.whl.metadata (1.6 kB)
Requirement already satisfied: numpy in /usr/local/lib/python3.11/dist-packages (from mnist) (1.26.4)
Using cached mnist-0.2.2-py2.py3-none-any.whl (3.5 kB)
Installing collected packages: mnist
Successfully installed mnist-0.2.2
</pre></div></div>
</div>
</section>
<section id="Build-tutorial-model">
<h2>Build tutorial model<a class="headerlink" href="#Build-tutorial-model" title="Link to this heading"></a></h2>
<p>Import modules</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">mnist</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">copy</span> <span class="kn">import</span> <span class="n">copy</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="kn">from</span> <span class="nn">pygenn</span> <span class="kn">import</span> <span class="p">(</span><span class="n">create_current_source_model</span><span class="p">,</span> <span class="n">init_postsynaptic</span><span class="p">,</span>
                    <span class="n">init_sparse_connectivity</span><span class="p">,</span> <span class="n">init_weight_update</span><span class="p">,</span> <span class="n">GeNNModel</span><span class="p">)</span>

<span class="n">mnist</span><span class="o">.</span><span class="n">datasets_url</span> <span class="o">=</span> <span class="s2">&quot;https://storage.googleapis.com/cvdf-datasets/mnist/&quot;</span>
<span class="n">training_images</span> <span class="o">=</span> <span class="n">mnist</span><span class="o">.</span><span class="n">train_images</span><span class="p">()</span>
<span class="n">training_images</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">training_images</span><span class="p">,</span> <span class="p">(</span><span class="n">training_images</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

<span class="c1"># Reshape and normalise training data</span>
<span class="n">training_images</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">training_images</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
</pre></div>
</div>
</div>
</section>
<section id="Parameters">
<h2>Parameters<a class="headerlink" href="#Parameters" title="Link to this heading"></a></h2>
<p>Define some model parameters</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Simulation time step</span>
<span class="n">DT</span> <span class="o">=</span> <span class="mf">0.1</span>

<span class="c1"># Scaling factor for converting normalised image pixels to input currents (nA)</span>
<span class="n">INPUT_SCALE</span> <span class="o">=</span> <span class="mf">80.0</span>

<span class="c1"># Number of Projection Neurons in model (should match image size)</span>
<span class="n">NUM_PN</span> <span class="o">=</span> <span class="mi">784</span>

<span class="c1"># Number of Kenyon Cells in model (defines memory capacity)</span>
<span class="n">NUM_KC</span> <span class="o">=</span> <span class="mi">20000</span>

<span class="c1"># How long to present each image to model</span>
<span class="n">PRESENT_TIME_MS</span> <span class="o">=</span> <span class="mf">20.0</span>

<span class="c1"># Standard LIF neurons parameters</span>
<span class="n">LIF_PARAMS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;C&quot;</span><span class="p">:</span> <span class="mf">0.2</span><span class="p">,</span>
    <span class="s2">&quot;TauM&quot;</span><span class="p">:</span> <span class="mf">20.0</span><span class="p">,</span>
    <span class="s2">&quot;Vrest&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mf">60.0</span><span class="p">,</span>
    <span class="s2">&quot;Vreset&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mf">60.0</span><span class="p">,</span>
    <span class="s2">&quot;Vthresh&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mf">50.0</span><span class="p">,</span>
    <span class="s2">&quot;Ioffset&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
    <span class="s2">&quot;TauRefrac&quot;</span><span class="p">:</span> <span class="mf">2.0</span><span class="p">}</span>

<span class="c1"># We only want PNs to spike once</span>
<span class="n">PN_PARAMS</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">LIF_PARAMS</span><span class="p">)</span>
<span class="n">PN_PARAMS</span><span class="p">[</span><span class="s2">&quot;TauRefrac&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">100.0</span>
</pre></div>
</div>
</div>
<p>As we’re now going to be adding our synaptic connections between the Projection Neurons and a new population of Kenyon Cells, also define some parameter for these</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Weight of each synaptic connection</span>
<span class="n">PN_KC_WEIGHT</span> <span class="o">=</span> <span class="mf">0.2</span>

<span class="c1"># Time constant of synaptic integration</span>
<span class="n">PN_KC_TAU_SYN</span> <span class="o">=</span> <span class="mf">3.0</span>

<span class="c1"># How many projection neurons should be connected to each Kenyon Cell</span>
<span class="n">PN_KC_FAN_IN</span> <span class="o">=</span> <span class="mi">20</span>
</pre></div>
</div>
</div>
</section>
<section id="Custom-models">
<h2>Custom models<a class="headerlink" href="#Custom-models" title="Link to this heading"></a></h2>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Current source model, allowing current to be injected into neuron from variable</span>
<span class="n">cs_model</span> <span class="o">=</span> <span class="n">create_current_source_model</span><span class="p">(</span>
    <span class="s2">&quot;cs_model&quot;</span><span class="p">,</span>
    <span class="nb">vars</span><span class="o">=</span><span class="p">[(</span><span class="s2">&quot;magnitude&quot;</span><span class="p">,</span> <span class="s2">&quot;scalar&quot;</span><span class="p">)],</span>
    <span class="n">injection_code</span><span class="o">=</span><span class="s2">&quot;injectCurrent(magnitude);&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</section>
<section id="Model-definition">
<h2>Model definition<a class="headerlink" href="#Model-definition" title="Link to this heading"></a></h2>
<p>Create a new model called “mnist_mb_second_layer” as before but add a second population of <code class="docutils literal notranslate"><span class="pre">NUM_KC</span></code> neurons to represent the Kenyon Cells.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create model</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">GeNNModel</span><span class="p">(</span><span class="s2">&quot;float&quot;</span><span class="p">,</span> <span class="s2">&quot;mnist_mb_second_layer&quot;</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">dt</span> <span class="o">=</span> <span class="n">DT</span>

<span class="c1"># Create neuron populations</span>
<span class="n">lif_init</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;V&quot;</span><span class="p">:</span> <span class="n">PN_PARAMS</span><span class="p">[</span><span class="s2">&quot;Vreset&quot;</span><span class="p">],</span> <span class="s2">&quot;RefracTime&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">}</span>
<span class="n">pn</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">add_neuron_population</span><span class="p">(</span><span class="s2">&quot;pn&quot;</span><span class="p">,</span> <span class="n">NUM_PN</span><span class="p">,</span> <span class="s2">&quot;LIF&quot;</span><span class="p">,</span> <span class="n">PN_PARAMS</span><span class="p">,</span> <span class="n">lif_init</span><span class="p">)</span>
<span class="n">kc</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">add_neuron_population</span><span class="p">(</span><span class="s2">&quot;kc&quot;</span><span class="p">,</span> <span class="n">NUM_KC</span><span class="p">,</span> <span class="s2">&quot;LIF&quot;</span><span class="p">,</span> <span class="n">LIF_PARAMS</span><span class="p">,</span> <span class="n">lif_init</span><span class="p">)</span>

<span class="c1"># Turn on spike recording</span>
<span class="n">pn</span><span class="o">.</span><span class="n">spike_recording_enabled</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">kc</span><span class="o">.</span><span class="n">spike_recording_enabled</span> <span class="o">=</span> <span class="kc">True</span>

<span class="c1"># Create current sources to deliver input to network</span>
<span class="n">pn_input</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">add_current_source</span><span class="p">(</span><span class="s2">&quot;pn_input&quot;</span><span class="p">,</span> <span class="n">cs_model</span><span class="p">,</span> <span class="n">pn</span> <span class="p">,</span> <span class="p">{},</span> <span class="p">{</span><span class="s2">&quot;magnitude&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">})</span>
</pre></div>
</div>
</div>
<p>Add a current source to inject current into <code class="docutils literal notranslate"><span class="pre">pn</span></code> using our newly-defined custom model with the initial magnitude set to zero.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create synapse populations</span>
<span class="n">pn_kc</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">add_synapse_population</span><span class="p">(</span><span class="s2">&quot;pn_kc&quot;</span><span class="p">,</span> <span class="s2">&quot;SPARSE&quot;</span><span class="p">,</span>
                                     <span class="n">pn</span><span class="p">,</span> <span class="n">kc</span><span class="p">,</span>
                                     <span class="n">init_weight_update</span><span class="p">(</span><span class="s2">&quot;StaticPulseConstantWeight&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;g&quot;</span><span class="p">:</span> <span class="n">PN_KC_WEIGHT</span><span class="p">}),</span>
                                     <span class="n">init_postsynaptic</span><span class="p">(</span><span class="s2">&quot;ExpCurr&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;tau&quot;</span><span class="p">:</span> <span class="n">PN_KC_TAU_SYN</span><span class="p">}),</span>
                                     <span class="n">init_sparse_connectivity</span><span class="p">(</span><span class="s2">&quot;FixedNumberPreWithReplacement&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;num&quot;</span><span class="p">:</span> <span class="n">PN_KC_FAN_IN</span><span class="p">}))</span>
</pre></div>
</div>
</div>
</section>
<section id="Build-model">
<h2>Build model<a class="headerlink" href="#Build-model" title="Link to this heading"></a></h2>
<p>Generate code and load it into PyGeNN allocating a large enough spike recording buffer to cover <code class="docutils literal notranslate"><span class="pre">PRESENT_TIME_MS</span></code> (after converting from ms to timesteps)</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Concert present time into timesteps</span>
<span class="n">present_timesteps</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">PRESENT_TIME_MS</span> <span class="o">/</span> <span class="n">DT</span><span class="p">))</span>

<span class="c1"># Build model and load it</span>
<span class="n">model</span><span class="o">.</span><span class="n">build</span><span class="p">()</span>
<span class="n">model</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">num_recording_timesteps</span><span class="o">=</span><span class="n">present_timesteps</span><span class="p">)</span>
</pre></div>
</div>
</div>
</section>
<section id="Simulate-tutorial-model">
<h2>Simulate tutorial model<a class="headerlink" href="#Simulate-tutorial-model" title="Link to this heading"></a></h2>
<p>As well as resetting the state of every neuron after presenting each stimuli, because we have now added synapses with their own dynamics, these also need to be reset. This function resets neuron state variables selected by the keys of a dictionary to the values specifed in the dictionary values and pushes the new values to the GPU.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">reset_out_post</span><span class="p">(</span><span class="n">pop</span><span class="p">):</span>
    <span class="n">pop</span><span class="o">.</span><span class="n">out_post</span><span class="o">.</span><span class="n">view</span><span class="p">[:]</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">pop</span><span class="o">.</span><span class="n">out_post</span><span class="o">.</span><span class="n">push_to_device</span><span class="p">()</span>
</pre></div>
</div>
</div>
<p>Now, like before, we loop through 4 stimuli and simulate the model. However, now we need to reset the Projection Neuron and Kenyon Cell populations; <strong>and</strong> the synapses between them. Additionally, we want to show spikes from the Kenyon Cells as well as the Projection Neurons.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">reset_neuron</span><span class="p">(</span><span class="n">pop</span><span class="p">,</span> <span class="n">var_init</span><span class="p">):</span>
    <span class="c1"># Reset variables</span>
    <span class="k">for</span> <span class="n">var_name</span><span class="p">,</span> <span class="n">var_val</span> <span class="ow">in</span> <span class="n">var_init</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">pop</span><span class="o">.</span><span class="n">vars</span><span class="p">[</span><span class="n">var_name</span><span class="p">]</span><span class="o">.</span><span class="n">view</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">var_val</span>

        <span class="c1"># Push the new values to GPU</span>
        <span class="n">pop</span><span class="o">.</span><span class="n">vars</span><span class="p">[</span><span class="n">var_name</span><span class="p">]</span><span class="o">.</span><span class="n">push_to_device</span><span class="p">()</span>

<span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
    <span class="c1"># Set training image</span>
    <span class="n">pn_input</span><span class="o">.</span><span class="n">vars</span><span class="p">[</span><span class="s2">&quot;magnitude&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">view</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">training_images</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">*</span> <span class="n">INPUT_SCALE</span>
    <span class="n">pn_input</span><span class="o">.</span><span class="n">vars</span><span class="p">[</span><span class="s2">&quot;magnitude&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">push_to_device</span><span class="p">()</span>

    <span class="c1"># Simulate present timesteps</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">present_timesteps</span><span class="p">):</span>
        <span class="n">model</span><span class="o">.</span><span class="n">step_time</span><span class="p">()</span>

    <span class="c1"># Reset neuron state for next stimuli</span>
    <span class="n">reset_neuron</span><span class="p">(</span><span class="n">pn</span><span class="p">,</span> <span class="n">lif_init</span><span class="p">)</span>
    <span class="n">reset_neuron</span><span class="p">(</span><span class="n">kc</span><span class="p">,</span> <span class="n">lif_init</span><span class="p">)</span>

    <span class="c1"># Reset synapse state</span>
    <span class="n">reset_out_post</span><span class="p">(</span><span class="n">pn_kc</span><span class="p">)</span>

    <span class="c1"># Download spikes from GPU</span>
    <span class="n">model</span><span class="o">.</span><span class="n">pull_recording_buffers_from_device</span><span class="p">()</span>

    <span class="c1"># Plot PN and KC spikes</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">pn_spike_times</span><span class="p">,</span> <span class="n">pn_spike_ids</span> <span class="o">=</span> <span class="n">pn</span><span class="o">.</span><span class="n">spike_recording_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">kc_spike_times</span><span class="p">,</span> <span class="n">kc_spike_ids</span> <span class="o">=</span> <span class="n">kc</span><span class="o">.</span><span class="n">spike_recording_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">kc_spike_ids</span><span class="p">))</span><span class="si">}</span><span class="s2"> KC active&quot;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">pn_spike_times</span><span class="p">,</span> <span class="n">pn_spike_ids</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;PN&quot;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">kc_spike_times</span><span class="p">,</span> <span class="n">kc_spike_ids</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Time [ms]&quot;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;KC&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
3718 KC active
4801 KC active
2001 KC active
894 KC active
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/tutorials_mushroom_body_2_second_layer_21_1.png" src="../../_images/tutorials_mushroom_body_2_second_layer_21_1.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/tutorials_mushroom_body_2_second_layer_21_2.png" src="../../_images/tutorials_mushroom_body_2_second_layer_21_2.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/tutorials_mushroom_body_2_second_layer_21_3.png" src="../../_images/tutorials_mushroom_body_2_second_layer_21_3.png" />
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/tutorials_mushroom_body_2_second_layer_21_4.png" src="../../_images/tutorials_mushroom_body_2_second_layer_21_4.png" />
</div>
</div>
<p>Oh dear! Even with normalised inputs and controlling for the initial state of the model before presenting each stimuli, we get very variable numbers of active Kenyon Cells.</p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="1_first_layer.html" class="btn btn-neutral float-left" title="Presenting latency-coded inputs" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="3_second_layer_gain_control.html" class="btn btn-neutral float-right" title="Feedback-inhibition based gain control" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, James Knight, Thomas Nowotny.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>